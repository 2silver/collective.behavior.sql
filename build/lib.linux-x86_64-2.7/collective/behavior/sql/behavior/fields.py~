from zope.interface import implements
from plone.schemaeditor.fields import FieldFactory, FieldsVocabularyFactory
from collective.behavior.sql.interfaces import ISQLFieldFactory
from zope.component import getUtilitiesFor
from zope.schema.vocabulary import SimpleVocabulary
from zope.i18n import translate
from zope.globalrequest import getRequest

class SQLFieldFactory(FieldFactory):
    implements(ISQLFieldFactory)

class SQLFieldsVocabularyFactory(FieldsVocabularyFactory):
    request = getRequest()
    field_factories = getUtilitiesFor(ISQLFieldFactory)
    if context.allowedFields is not None:
        field_factories = [(id, factory) for id, factory in field_factories
                            if id in context.allowedFields]
    terms = []
    for (field_id, factory) in field_factories:
        terms.append(SimpleVocabulary.createTerm(factory,
                                                 factory.title,
                                                 translate(factory.title, context=request)))
    terms = sorted(terms, key=operator.attrgetter('title'))
    return SimpleVocabulary(terms)
